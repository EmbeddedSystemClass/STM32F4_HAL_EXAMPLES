#include "VS1053.h"

const uint8_t _VS1053_WRITE_CMD        = 0x02;
const uint8_t _VS1053_READ_CMD         = 0x03;

const uint8_t _VS1053_BASE_ADDR        = 0x00;
const uint8_t _VS1053_MODE_ADDR        = 0x00;
const uint8_t _VS1053_STATUS_ADDR      = 0x01;
const uint8_t _VS1053_BASS_ADDR        = 0x02;
const uint8_t _VS1053_CLOCKF_ADDR      = 0x03;
const uint8_t _VS1053_DECODE_TIME_ADDR = 0x04;
const uint8_t _VS1053_AUDATA_ADDR      = 0x05;
const uint8_t _VS1053_WRAM_ADDR        = 0x06;
const uint8_t _VS1053_WRAMADDR_ADDR    = 0x07;
const uint8_t _VS1053_HDAT0_ADDR       = 0x08;
const uint8_t _VS1053_HDAT1_ADDR       = 0x09;
const uint8_t _VS1053_AIADDR_ADDR      = 0x0A;
const uint8_t _VS1053_VOL_ADDR         = 0x0B;
const uint8_t _VS1053_AICTRL0_ADDR     = 0x0C;
const uint8_t _VS1053_AICTRL1_ADDR     = 0x0D;
const uint8_t _VS1053_AICTRL2_ADDR     = 0x0E;
const uint8_t _VS1053_AICTRL3_ADDR     = 0x0F;

void VS1053_Init()
{
    hal_gpio_intSet( 1 );		/* XDCS High */
    hal_gpio_csSet( 1 );		/* XCS High */
    hal_gpio_rstSet( 1 );		/* XRST High */
}

void VS1053_Reset()
{
    hal_gpio_rstSet( 0 );		/* XRST Low */
    Delay_100ms();				/* 100ms Delay */
    hal_gpio_rstSet( 1 );		/* XRST High */

    while (!hal_gpio_anGet())	/* Wait DREQ High */
    {
    }
}

uint8_t VS1053_IsBusy()
{
    if (hal_gpio_anGet())		/* DREQ High */
    {
        return 0;				/* Ready */
    }
    else
    {
        return 1;				/* Busy */
    }
}

void VS1053_CmdWrite( uint8_t address, uint16_t input )
{
    uint8_t tmp[ 4 ];

    tmp[ 0 ] = _VS1053_WRITE_CMD;
    tmp[ 1 ] = address;
    tmp[ 2 ] = input >> 8;			/* Input MSB */
    tmp[ 3 ] = input & 0x00FF;		/* Input LSB */

    hal_gpio_csSet( 0 );			/* XCS Low */
    hal_spiWrite( tmp, 4 );			/* SPI Tx */
    hal_gpio_csSet( 1 );			/* XCS High */

    while (!hal_gpio_anGet());		/* Wait DREQ High(Ready) */
}

uint16_t VS1053_CmdRead( uint8_t address )
{
    uint8_t tmp_in[ 4 ];
    uint8_t tmp_out[ 4 ];
    uint16_t res;

    tmp_in[ 0 ] = _VS1053_READ_CMD;
    tmp_in[ 1 ] = address;
    tmp_in[ 2 ] = 0;
    tmp_in[ 3 ] = 0;


    hal_gpio_csSet( 0 );			/* XCS Low */
    hal_spiTransfer( tmp_in, tmp_out, 4 );		/* SPI TxRx */
    hal_gpio_csSet( 1 );			/* XCS High */

    res = tmp_out[3];				/* Received data */
    res <<= 8;						/* MSB */
    res |= tmp_out[4];				/* LSB */

    while (!hal_gpio_anGet());		/* Wait DREQ High(Ready) */

    return res;
}

uint8_t VS1053_DataWrite( uint8_t input )
{
    uint8_t tmp;

    if (!hal_gpio_anGet())			/* If DREQ Low(Busy), return error */
    {
        return 1;
    }

    tmp = input;

    hal_gpio_intSet( 0 );			/* XDCS Low(SDI) */
    hal_spiWrite( &tmp, 1 );		/* SPI Tx 1 byte */
    hal_gpio_intSet( 1 );			/* XDCS High(SDI) */

    return 0;
}

uint8_t VS1053_DataWrite32( uint8_t *input32 )
{
    if (!hal_gpio_anGet())			/* If DREQ Low(Busy), return error */
    {
        return 1;
    }

    hal_gpio_intSet( 0 );			/* XDCS Low(SDI) */
    hal_spiWrite( input32, 32 );	/* SPI Tx 32 bytes */
    hal_gpio_intSet( 1 );			/* XDCS High(SDI) */

    return 0;
}
